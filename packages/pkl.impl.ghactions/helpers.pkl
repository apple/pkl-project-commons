//===----------------------------------------------------------------------===//
// Copyright Â© 2025 Apple Inc. and the Pkl project authors. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//===----------------------------------------------------------------------===//
module pkl.impl.ghactions.helpers

import "@gha/Context.pkl"
import "@gha/Workflow.pkl"

const withMavenPublishSecrets: Mixin<Workflow.Step> = new {
  env {
    ["ORG_GRADLE_PROJECT_signingKeyId"] = Context.secrets("ORG_GRADLE_PROJECT_SIGNINGKEYID")
    ["ORG_GRADLE_PROJECT_signingKey"] = Context.secrets("ORG_GRADLE_PROJECT_SIGNINGKEY")
    ["ORG_GRADLE_PROJECT_signingPassword"] = Context.secrets("ORG_GRADLE_PROJECT_SIGNINGPASSWORD")
    ["ORG_GRADLE_PROJECT_sonatypePassword"] = Context.secrets("ORG_GRADLE_PROJECT_SONATYPEPASSWORD")
    ["ORG_GRADLE_PROJECT_sonatypeUsername"] = Context.secrets("ORG_GRADLE_PROJECT_SONATYPEUSERNAME")
  }
}

/// Use this for an `if` condition on jobs that "fan in" from multiple ancestors when one or more of
/// those ancestors runs conditionally.
///
/// The four job states in GHA are:
/// * success - completed successfully, checked by `success()`.
/// * failure - ran unsuccessfully, checked by `failure()`.
/// * cancelled - explicit user cancellation, checked by `cancelled()`.
/// * skipped - skipped due to `if` condition, no check function.
///
/// Per [the docs](https://docs.github.com/en/actions/reference/workflows-and-actions/expressions#status-check-functions):
/// > A default status check of success() is applied unless you include one of these functions.
///
/// This condition overrides the default behavior to proceed if all ancestor jobs have result
/// `success` or `skipped`.
const ifNoUpstreamFailures: String = "!failure() && !cancelled()"
